# Copyright (c) 2020 The University of Manchester
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# This workflow will install Python dependencies, run tests, lint and rat with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Self Hosted Tests

on: [push]

jobs:
  integration_tests:
      runs-on: self-hosted
      container:
          image: python3.6:latest
      steps:
      - name: Checkout
        uses: actions/checkout@v2
        
      - name: Ping the machine
        run: ping -c 1 10.11.193.0
        
      - name: Install Python Dependencies
        run: |
          pip3 install --upgrade "setuptools < 50.0.0" wheel
          pip install --user --upgrade pip
          pip install --user --only-binary=numpy,scipy,matplotlib numpy scipy matplotlib

      - name: Clone Repositories to be tested
        run: | 
          git clone https://github.com/SpiNNakerManchester/SupportScripts.git support
          # SpiNNakerManchester internal dependencies; development mode
          support/gitclone2.sh https://github.com/SpiNNakerManchester/SpiNNUtils.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/SpiNNMachine.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/SpiNNMan.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/PACMAN.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/DataSpecification.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/spalloc.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/sPyNNaker8.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/SpiNNakerGraphFrontEnd.git
          # C dependencies
          support/gitclone2.sh https://github.com/SpiNNakerManchester/spinnaker_tools.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/spinn_common.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/SpiNNFrontEndCommon.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/sPyNNaker.git
          # Java dependencies
          support/gitclone2.sh https://github.com/SpiNNakerManchester/JavaSpiNNaker
          # scripts
          support/gitclone2.sh https://github.com/SpiNNakerManchester/IntroLab.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/PyNN8Examples.git
          support/gitclone2.sh https://github.com/SpiNNakerManchester/sPyNNaker8NewModelTemplate.git
          support/gitclone2.sh https://${{ secrets.AUTH_SECRET }}@github.com/SpiNNakerManchester/microcircuit_model.git

      - name: Install
        env:
          SPINN_DIRS: ${{ env.GITHUB_WORKSPACE }}/spinnaker_tools
          NEURAL_MODELLING_DIRS: ${{ env.GITHUB_WORKSPACE }}/sPyNNaker/neural_modelling
        run: |
          # Install SpiNNUtils first as needed for C build
          cd SpiNNUtils && python setup.py develop
          # C Build next as builds files to be installed in Python
          make -C $SPINN_DIRS
          make -C spinn_common install
          make -C SpiNNFrontEndCommon/c_common
          make -C SpiNNFrontEndCommon/c_common install
          make -C sPyNNaker/neural_modelling
          make -C sPyNNaker8NewModelTemplate/c_models
          make -C SpiNNakerGraphFrontEnd/spinnaker_graph_front_end/examples
          make -C SpiNNakerGraphFrontEnd/gfe_integration_tests/
          # Python install
          cd SpiNNMachine && python setup.py develop
          cd SpiNNMan && python setup.py develop
          cd PACMAN && python setup.py develop
          cd DataSpecification && python setup.py develop
          cd spalloc && python setup.py develop
          cd SpiNNFrontEndCommon && python setup.py develop
          cd sPyNNaker && python setup.py develop
          cd sPyNNaker8 && python ./setup.py develop
          cd sPyNNaker8NewModelTemplate && python ./setup.py develop
          cd SpiNNakerGraphFrontEnd && python ./setup.py develop
          python -m spynnaker8.setup_pynn
          # Test requirements
          pip install -r SpiNNMachine/requirements-test.txt
          pip install -r SpiNNMan/requirements-test.txt
          pip install -r PACMAN/requirements-test.txt
          pip install -r DataSpecification/requirements-test.txt
          pip install -r spalloc/requirements-test.txt
          pip install -r SpiNNFrontEndCommon/requirements-test.txt
          pip install -r sPyNNaker/requirements-test.txt
          pip install -r sPyNNaker8/requirements-test.txt
          pip install -r SpiNNakerGraphFrontEnd/requirements-test.txt
          # Additional requirements for testing here
          # coverage version capped due to https://github.com/nedbat/coveragepy/issues/883
          pip install python-coveralls "coverage>=5.0.0"
          pip install pytest-instafail "pytest-xdist==1.34.0"
          # Java install
          mvn -f JavaSpiNNaker package
