# Copyright (c) 2020 The University of Manchester
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# This workflow will install Python dependencies, run tests, lint and rat with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Self Hosted Tests

on:
  push:
  schedule:
    - cron: '0 1 * * *'

jobs:
  integration_tests:
    runs-on: self-hosted
    container:
        image: localhost:5000/python3.13:latest
    steps:
    - name: Checkout
      id: checkout
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.SPINNAKER_PAT }}

    - name: 'Setup jq'
      id: setup-jq
      uses: dcarbone/install-jq-action@v3

    - name: Install Python Dependencies
      id: python-install
      run: |
        pip install virtualenv
        virtualenv pyenv
        source pyenv/bin/activate
        pip install --upgrade setuptools wheel
        pip install --upgrade pip

    - name: Setup Environment
      shell: bash
      run: |
          echo "SPINN_DIRS=${GITHUB_WORKSPACE}/spinnaker_tools" >> $GITHUB_ENV
          echo "NEURAL_MODELLING_DIRS=${GITHUB_WORKSPACE}/sPyNNaker/neural_modelling" >> $GITHUB_ENV
          echo "GLOBAL_REPORTS=${GITHUB_WORKSPACE}/global_reports" >> $GITHUB_ENV
          echo "SPALLOC_USER=${{ secrets.SPALLOC_USER }}" >> $GITHUB_ENV
          echo "SPALLOC_PASSWORD=${{ secrets.SPALLOC_PASSWORD }}" >> $GITHUB_ENV

        echo
      id: set_env_step

    - name: Clone Repositories to be tested
      id: clone-repos
      uses: ./.github/actions/clone_matching
      with:
        repository: |
          https://github.com/SpiNNakerManchester/SpiNNUtils.git
          https://github.com/SpiNNakerManchester/SpiNNMachine.git
          https://github.com/SpiNNakerManchester/SpiNNMan.git
          https://github.com/SpiNNakerManchester/PACMAN.git
          https://github.com/SpiNNakerManchester/spalloc.git
          https://github.com/SpiNNakerManchester/spinnaker_tools.git
          https://github.com/SpiNNakerManchester/spinn_common.git
          https://github.com/SpiNNakerManchester/SpiNNFrontEndCommon.git
          https://github.com/SpiNNakerManchester/sPyNNaker.git
          https://github.com/SpiNNakerManchester/JavaSpiNNaker.git
          https://github.com/SpiNNakerManchester/TestBase.git

    - name: Setup SpiNNUtils
      id: setup-spinnutils
      run: |
        source pyenv/bin/activate
        pip install ./SpiNNUtils[test]

    - name: Make C Code
      id: make-c-code
      run: |
        source pyenv/bin/activate
        make -C $SPINN_DIRS
        make -C spinn_common install
        make -C SpiNNFrontEndCommon/c_common
        make -C SpiNNFrontEndCommon/c_common install
        make -C sPyNNaker/neural_modelling

    - name: Install Python Modules
      id: install-python-modules
      run: |
        source pyenv/bin/activate
        pip install ./SpiNNMachine[test]
        pip install ./SpiNNMan[test]
        pip install ./PACMAN[test]
        pip install ./spalloc[test]
        pip install ./SpiNNFrontEndCommon[test]
        pip install ./TestBase[test]
        pip install ./sPyNNaker[test]
        python -m spynnaker.pyNN.setup_pynn
        # Additional requirements for testing here
        # coverage version capped due to https://github.com/nedbat/coveragepy/issues/883
        pip install nbmake python-coveralls "coverage>=5.0.0" pytest-instafail pytest-xdist pytest-progress pytest-forked pytest-timeout
        pip freeze

    - name: Install Java
      id: install-java
      run: |
        java -version
        mvn -version
        mvn package -B -f JavaSpiNNaker -pl -SpiNNaker-allocserv -DskipTests

    - name: Delete Install Sources
      id: delete-install-sources
      run: |
        rm -rf spinn_common
        rm -rf SpiNNUtils/spinn_utilities
        rm -rf SpiNNUtils/build
        rm -rf SpiNNMachine/spinn_machine
        rm -rf SpiNNMachine/build
        rm -rf SpiNNMan/spinnman
        rm -rf SpiNNMan/build
        rm -rf PACMAN/pacman
        rm -rf PACMAN/pacman_test_objects
        rm -rf PACMAN/build
        rm -rf spalloc/spalloc_client
        rm -rf spalloc/build
        rm -rf SpiNNFrontEndCommon/spinn_front_end_common
        rm -rf SpiNNFrontEndCommon/c_common
        rm -rf SpiNNFrontEndCommon/build
        rm -rf TestBase/spinnaker_testbase
        rm -rf TestBase/build
        rm -rf sPyNNaker/spynnaker
        rm -rf sPyNNaker/neural_modelling
        rm -rf sPyNNaker/build

    # --------------------------------------------------------------------


    # --------------------------------------------------------------------

    - name: Check previous
      id: test-previous
      if: always()
      env:
        STEPS_CONTEXT: ${{ toJson(steps) }}
      run: |
        export failed_steps=$(echo "$STEPS_CONTEXT" | jq -r 'keys[] as $k | select(.[$k].outcome=="failure") | "\($k): \(.[$k].outcome)"')
        echo "$failed_steps"
        if echo "$failed_steps" | grep -q "failure"; then
          echo "prev_ok=false" >> $GITHUB_OUTPUT
          echo "fail"
        else
          echo "prev_ok=true" >> $GITHUB_OUTPUT
          echo "pass"
        fi

    # --------------------------------------------------------------------

    - name: Run Whole  Board Integration Tests
      id: spynnaker-whole_board
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      uses: ./.github/actions/pytest_local
      with:
        tests: sPyNNaker/test_whole_board
        timeout: 96000
        results: sPyNNaker_whole_board
        covfile: integration
        n_threads: auto

    # --------------------------------------------------------------------

    - name: Check Reports
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      run: |
        source pyenv/bin/activate
        python -m spinn_utilities.executable_finder
        find ${GLOBAL_REPORTS} -print -exec cat \{\} \;

    - name: Check Destroyed
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      run: |
        source pyenv/bin/activate
        python -m spinnaker_testbase.test_no_job_destroy

    - name: Extract branch name
      shell: bash
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      run: |
        echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
      id: extract_branch

    - name: Create Coverage HTML
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      run: |
        source pyenv/bin/activate
        coverage html -d ${GITHUB_WORKSPACE}/coverage_html

    - name: Checkout Pages
      uses: actions/checkout@v5
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      with:
        ref: gh-pages
        path: ghpagesupdate
        token: ${{ secrets.SPINNAKER_PAT }}

    - name: Copy coverage for branch
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      run: |
        rm -rf ghpagesupdate/${{ steps.extract_branch.outputs.branch }}
        mkdir -p ghpagesupdate/${{ steps.extract_branch.outputs.branch }}
        cp -a ./coverage_html/* ghpagesupdate/${{ steps.extract_branch.outputs.branch }}/

    - name: Push Coverage to GitHub Pages
      if: always() && steps.test-previous.outputs.prev_ok == 'true'
      env:
        GH_TOKEN: ${{ secrets.SPINNAKER_PAT }}
      working-directory: ghpagesupdate
      run: |
        git config --global user.email "no-reply@github.com"
        git config --global user.name "GitHub Actions"
        git add -A
        git commit -a -m "Update Coverage"
        git push origin gh-pages
        echo "::notice::Coverage information deployed to https://spinnakermanchester.github.io/IntegrationTests/${{ steps.extract_branch.outputs.branch }}/"
